#!/bin/sh

# Enforce conventional branch names on push
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null || true)
case "$BRANCH_NAME" in
  feat/*|fix/*|chore/*|docs/*|refactor/*|test/*|ci/*|build/*|perf/*)
    ;;
  *)
    echo "Invalid branch name: $BRANCH_NAME" >&2
    echo "Expected: feat/*, fix/*, chore/*, docs/*, refactor/*, test/*, ci/*, build/*, perf/*" >&2
    exit 1
    ;;
esac

# Lint all commits since upstream (or a safe range if no upstream)
if git rev-parse --abbrev-ref --symbolic-full-name @{upstream} >/dev/null 2>&1; then
  BASE=$(git merge-base HEAD @{upstream})
  pnpm commitlint --from "$BASE" --to HEAD || exit 1
else
  # Compute a safe base commit even for very short histories
  COMMIT_COUNT=$(git rev-list --count HEAD)
  if [ "$COMMIT_COUNT" -gt 20 ]; then
    BASE=$(git rev-list --max-count=1 --skip=20 HEAD)
  else
    BASE=$(git rev-list --max-parents=0 --max-count=1 HEAD)
  fi
  pnpm commitlint --from "$BASE" --to HEAD || exit 1
fi

# Run quick checks before pushing
pnpm format:check && pnpm lint && pnpm test


